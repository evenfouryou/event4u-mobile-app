You've identified the 0603 error cause. Now implement both the date coherence fix AND the replacement logic together.                                    
                                                                                                                                                           
  ---                                                                                                                                                      
  BUG FIX: ERROR 0603 - DATE COHERENCE (CRITICAL)                                                                                                          
                                                                                                                                                           
  Error: "Le date dell'oggetto, del nome file, e del contenuto del riepilogo non sono coerenti"                                                            
                                                                                                                                                           
  Root Cause: DataGenerazione was using current date instead of report date.                                                                               
                                                                                                                                                           
  Fix Required:                                                                                                                                            
                                                                                                                                                           
  File: server/siae-utils.ts (around line 4824)                                                                                                            
                                                                                                                                                           
  Change:                                                                                                                                                  
  // ❌ WRONG - Uses current date                                                                                                                          
  DataGenerazione="${formatDate(new Date(), 'YYYYMMDD')}"                                                                                                  
                                                                                                                                                           
  // ✅ CORRECT - Uses report date                                                                                                                         
  DataGenerazione="${reportDate.replace(/-/g, '')}"                                                                                                        
                                                                                                                                                           
  All dates MUST match:                                                                                                                                    
  Filename:     RPG_2026_01_28_001.xsi                                                                                                                     
  XML Data:     Data="20260128"                                                                                                                            
  XML DataGen:  DataGenerazione="20260128"                                                                                                                 
                                                                                                                                                           
  ---                                                                                                                                                      
  FEATURE: AUTOMATIC REPLACEMENT DETECTION                                                                                                                 
                                                                                                                                                           
  Implement automatic detection of duplicate reports and set Sostituzione="S".                                                                             
                                                                                                                                                           
  Step 1: Create Database Table                                                                                                                            
                                                                                                                                                           
  CREATE TABLE IF NOT EXISTS siae_transmissions (                                                                                                          
      id INTEGER PRIMARY KEY AUTOINCREMENT,                                                                                                                
      report_type TEXT NOT NULL CHECK(report_type IN ('RPG', 'RPM', 'RMG')),                                                                               
      report_date TEXT NOT NULL,                                                                                                                           
      event_date TEXT NULL,                                                                                                                                
      progressivo_generazione INTEGER NOT NULL,                                                                                                            
      sostituzione TEXT DEFAULT 'N' CHECK(sostituzione IN ('N', 'S')),                                                                                     
      xml_hash TEXT NOT NULL,                                                                                                                              
      filename TEXT NOT NULL,                                                                                                                              
      response_code TEXT NULL,                                                                                                                             
      response_message TEXT NULL,                                                                                                                          
      status TEXT DEFAULT 'pending' CHECK(status IN ('pending', 'sent', 'accepted', 'rejected', 'error')),                                                 
      sent_at TEXT DEFAULT CURRENT_TIMESTAMP,                                                                                                              
      created_at TEXT DEFAULT CURRENT_TIMESTAMP,                                                                                                           
                                                                                                                                                           
      UNIQUE(report_type, report_date, event_date)                                                                                                         
  );                                                                                                                                                       
                                                                                                                                                           
  CREATE INDEX idx_transmissions_status ON siae_transmissions(status);                                                                                     
  CREATE INDEX idx_transmissions_date ON siae_transmissions(report_date);                                                                                  
                                                                                                                                                           
  Create this migration file:                                                                                                                              
  - Path: database/migrations/create_siae_transmissions.sql                                                                                                
  - Run on startup if table doesn't exist                                                                                                                  
                                                                                                                                                           
  ---                                                                                                                                                      
  Step 2: Check for Existing Transmission                                                                                                                  
                                                                                                                                                           
  Add this function BEFORE generating the report:                                                                                                          
                                                                                                                                                           
  async function checkExistingTransmission(                                                                                                                
    reportType: 'RPG' | 'RPM' | 'RMG',                                                                                                                     
    reportDate: string,                                                                                                                                    
    eventDate?: string                                                                                                                                     
  ): Promise<{                                                                                                                                             
    exists: boolean;                                                                                                                                       
    lastProgressivo: number;                                                                                                                               
    lastStatus: string | null;                                                                                                                             
    canReplace: boolean;                                                                                                                                   
  }> {                                                                                                                                                     
    const query = `                                                                                                                                        
      SELECT progressivo_generazione, status, response_code                                                                                                
      FROM siae_transmissions                                                                                                                              
      WHERE report_type = ?                                                                                                                                
        AND report_date = ?                                                                                                                                
        ${eventDate ? 'AND event_date = ?' : 'AND event_date IS NULL'}                                                                                     
      ORDER BY progressivo_generazione DESC                                                                                                                
      LIMIT 1                                                                                                                                              
    `;                                                                                                                                                     
                                                                                                                                                           
    const params = eventDate ? [reportType, reportDate, eventDate] : [reportType, reportDate];                                                             
    const existing = await db.get(query, params);                                                                                                          
                                                                                                                                                           
    if (!existing) {                                                                                                                                       
      return { exists: false, lastProgressivo: 0, lastStatus: null, canReplace: false };                                                                   
    }                                                                                                                                                      
                                                                                                                                                           
    // Can replace if previous was accepted or if it errored with 0604 (duplicate)                                                                         
    const canReplace =                                                                                                                                     
      existing.response_code === '0000' ||                                                                                                                 
      existing.response_code === '0604' ||                                                                                                                 
      existing.status === 'accepted';                                                                                                                      
                                                                                                                                                           
    return {                                                                                                                                               
      exists: true,                                                                                                                                        
      lastProgressivo: existing.progressivo_generazione,                                                                                                   
      lastStatus: existing.status,                                                                                                                         
      canReplace                                                                                                                                           
    };                                                                                                                                                     
  }                                                                                                                                                        
                                                                                                                                                           
  ---                                                                                                                                                      
  Step 3: Update Report Generation                                                                                                                         
                                                                                                                                                           
  Modify the main report generation function:                                                                                                              
                                                                                                                                                           
  async function generateAndSendReport(                                                                                                                    
    reportType: 'RPG' | 'RPM' | 'RMG',                                                                                                                     
    reportDate: string,                                                                                                                                    
    eventData: any,                                                                                                                                        
    eventDate?: string                                                                                                                                     
  ) {                                                                                                                                                      
    // 1. Check if already sent                                                                                                                            
    const existing = await checkExistingTransmission(reportType, reportDate, eventDate);                                                                   
                                                                                                                                                           
    let sostituzione = 'N';                                                                                                                                
    let progressivo = 1;                                                                                                                                   
                                                                                                                                                           
    if (existing.exists) {                                                                                                                                 
      if (!existing.canReplace) {                                                                                                                          
        console.warn(`[SIAE] Report already sent for ${reportDate}, status: ${existing.lastStatus}`);                                                      
        // Optionally ask user for confirmation here                                                                                                       
      }                                                                                                                                                    
                                                                                                                                                           
      sostituzione = 'S';  // Mark as replacement                                                                                                          
      progressivo = existing.lastProgressivo + 1;                                                                                                          
                                                                                                                                                           
      console.log(`[SIAE] Sending REPLACEMENT report (Sostituzione=S, Progressivo=${progressivo})`);                                                       
    }                                                                                                                                                      
                                                                                                                                                           
    // 2. Generate XML with correct dates and flags                                                                                                        
    const xmlData = {                                                                                                                                      
      reportType,                                                                                                                                          
      reportDate,  // Used for Data attribute                                                                                                              
      eventDate: eventDate || reportDate,  // For RMG                                                                                                      
      sostituzione,                                                                                                                                        
      progressivo,                                                                                                                                         
      ...eventData                                                                                                                                         
    };                                                                                                                                                     
                                                                                                                                                           
    const xml = generateC1Xml(xmlData);                                                                                                                    
                                                                                                                                                           
    // 3. Generate filename                                                                                                                                
    const dateForFilename = reportDate.replace(/-/g, '_').substring(2); // 2026-01-28 → 26_01_28                                                           
    const progressivoStr = progressivo.toString().padStart(3, '0');                                                                                        
    const filename = `${reportType}_20${dateForFilename}_${progressivoStr}.xsi`;                                                                           
                                                                                                                                                           
    // 4. Calculate hash                                                                                                                                   
    const xmlHash = crypto.createHash('sha256').update(xml).digest('hex');                                                                                 
                                                                                                                                                           
    // 5. Save to database BEFORE sending                                                                                                                  
    await db.run(`                                                                                                                                         
      INSERT INTO siae_transmissions (                                                                                                                     
        report_type, report_date, event_date, progressivo_generazione,                                                                                     
        sostituzione, xml_hash, filename, status                                                                                                           
      ) VALUES (?, ?, ?, ?, ?, ?, ?, 'pending')                                                                                                            
    `, [reportType, reportDate, eventDate, progressivo, sostituzione, xmlHash, filename]);                                                                 
                                                                                                                                                           
    // 6. Send email                                                                                                                                       
    try {                                                                                                                                                  
      await sendSIAEEmail(filename, xml);                                                                                                                  
                                                                                                                                                           
      await db.run(`                                                                                                                                       
        UPDATE siae_transmissions                                                                                                                          
        SET status = 'sent', sent_at = CURRENT_TIMESTAMP                                                                                                   
        WHERE report_type = ? AND report_date = ? AND progressivo_generazione = ?                                                                          
      `, [reportType, reportDate, progressivo]);                                                                                                           
                                                                                                                                                           
      console.log(`[SIAE] ✅ Report sent: ${filename}`);                                                                                                   
      return { success: true, filename, sostituzione, progressivo };                                                                                       
                                                                                                                                                           
    } catch (error) {                                                                                                                                      
      await db.run(`                                                                                                                                       
        UPDATE siae_transmissions                                                                                                                          
        SET status = 'error', response_message = ?                                                                                                         
        WHERE report_type = ? AND report_date = ? AND progressivo_generazione = ?                                                                          
      `, [error.message, reportType, reportDate, progressivo]);                                                                                            
                                                                                                                                                           
      throw error;                                                                                                                                         
    }                                                                                                                                                      
  }                                                                                                                                                        
                                                                                                                                                           
  ---                                                                                                                                                      
  Step 4: Fix XML Generation (DATE COHERENCE)                                                                                                              
                                                                                                                                                           
  CRITICAL: All dates must match                                                                                                                           
                                                                                                                                                           
  function generateC1Xml(data: any): string {                                                                                                              
    const {                                                                                                                                                
      reportType,                                                                                                                                          
      reportDate,     // e.g., "2026-01-28"                                                                                                                
      eventDate,                                                                                                                                           
      sostituzione,                                                                                                                                        
      progressivo,                                                                                                                                         
      events                                                                                                                                               
    } = data;                                                                                                                                              
                                                                                                                                                           
    // Format: YYYYMMDD (remove dashes)                                                                                                                    
    const reportDateFormatted = reportDate.replace(/-/g, '');  // "20260128"                                                                               
    const eventDateFormatted = eventDate.replace(/-/g, '');                                                                                                
                                                                                                                                                           
    // Current timestamp for OraGenerazione                                                                                                                
    const now = new Date();                                                                                                                                
    const oraGenerazione = now.getHours().toString().padStart(2, '0') +                                                                                    
                           now.getMinutes().toString().padStart(2, '0') +                                                                                  
                           now.getSeconds().toString().padStart(2, '0');                                                                                   
                                                                                                                                                           
    const progressivoStr = progressivo.toString().padStart(3, '0');                                                                                        
                                                                                                                                                           
    // ✅ CRITICAL: DataGenerazione MUST match reportDate, NOT current date                                                                                
    const xml = `<?xml version="1.0" encoding="UTF-8"?>                                                                                                    
  <${reportType === 'RPG' ? 'RiepilogoGiornaliero' : 'RiepilogoMensile'}                                                                                   
    Data="${reportDateFormatted}"                                                                                                                          
    DataGenerazione="${reportDateFormatted}"                                                                                                               
    OraGenerazione="${oraGenerazione}"                                                                                                                     
    ProgressivoGenerazione="${progressivoStr}"                                                                                                             
    Sostituzione="${sostituzione}">                                                                                                                        
    <Titolare>                                                                                                                                             
      <Denominazione>HURAEX SRL</Denominazione>                                                                                                            
      <CodiceFiscale>02120820432</CodiceFiscale>                                                                                                           
      <SistemaEmissione>P0004010</SistemaEmissione>                                                                                                        
    </Titolare>                                                                                                                                            
    ...                                                                                                                                                    
  </${reportType === 'RPG' ? 'RiepilogoGiornaliero' : 'RiepilogoMensile'}>`;                                                                               
                                                                                                                                                           
    return xml;                                                                                                                                            
  }                                                                                                                                                        
                                                                                                                                                           
  ---                                                                                                                                                      
  Step 5: Process SIAE Response                                                                                                                            
                                                                                                                                                           
  When SIAE response arrives:                                                                                                                              
                                                                                                                                                           
  async function processSIAEResponse(responseFilename: string, responseContent: string) {                                                                  
    // Parse: RPG_2026_01_28_001.xsi_2026_01_28_0800008258_0000.txt                                                                                        
    const match = responseFilename.match(/^(RPG|RPM|RMG)_(\d{4})_(\d{2})_(\d{2})_(\d+)/);                                                                  
                                                                                                                                                           
    if (!match) {                                                                                                                                          
      console.error('[SIAE] Invalid response filename:', responseFilename);                                                                                
      return;                                                                                                                                              
    }                                                                                                                                                      
                                                                                                                                                           
    const [_, reportType, year, month, day, progressivoStr] = match;                                                                                       
    const reportDate = `${year}-${month}-${day}`;                                                                                                          
    const progressivo = parseInt(progressivoStr);                                                                                                          
                                                                                                                                                           
    // Extract response code                                                                                                                               
    const codeMatch = responseContent.match(/CODICE:\s+(\d+)/);                                                                                            
    const code = codeMatch ? codeMatch[1] : null;                                                                                                          
                                                                                                                                                           
    // Determine status                                                                                                                                    
    let status = 'rejected';                                                                                                                               
    if (code === '0000') status = 'accepted';                                                                                                              
    else if (code === '0604') status = 'rejected'; // Duplicate                                                                                            
                                                                                                                                                           
    // Update database                                                                                                                                     
    await db.run(`                                                                                                                                         
      UPDATE siae_transmissions                                                                                                                            
      SET response_code = ?,                                                                                                                               
          response_message = ?,                                                                                                                            
          status = ?                                                                                                                                       
      WHERE report_type = ?                                                                                                                                
        AND report_date = ?                                                                                                                                
        AND progressivo_generazione = ?                                                                                                                    
    `, [code, responseContent, status, reportType, reportDate, progressivo]);                                                                              
                                                                                                                                                           
    console.log(`[SIAE] Response: ${reportType} ${reportDate} Prog ${progressivo} - Code ${code} (${status})`);                                            
  }                                                                                                                                                        
                                                                                                                                                           
  ---                                                                                                                                                      
  Step 6: Validation Before Sending                                                                                                                        
                                                                                                                                                           
  Add validation to catch date mismatches:                                                                                                                 
                                                                                                                                                           
  function validateReportDates(filename: string, xml: string): { valid: boolean; errors: string[] } {                                                      
    const errors: string[] = [];                                                                                                                           
                                                                                                                                                           
    // Extract date from filename: RPG_2026_01_28_001.xsi                                                                                                  
    const filenameMatch = filename.match(/RPG_(\d{4})_(\d{2})_(\d{2})/);                                                                                   
    if (!filenameMatch) {                                                                                                                                  
      errors.push('Invalid filename format');                                                                                                              
      return { valid: false, errors };                                                                                                                     
    }                                                                                                                                                      
                                                                                                                                                           
    const filenameDate = `${filenameMatch[1]}${filenameMatch[2]}${filenameMatch[3]}`;  // "20260128"                                                       
                                                                                                                                                           
    // Extract dates from XML                                                                                                                              
    const dataMatch = xml.match(/Data="(\d{8})"/);                                                                                                         
    const dataGenMatch = xml.match(/DataGenerazione="(\d{8})"/);                                                                                           
                                                                                                                                                           
    if (!dataMatch || !dataGenMatch) {                                                                                                                     
      errors.push('Missing Data or DataGenerazione in XML');                                                                                               
      return { valid: false, errors };                                                                                                                     
    }                                                                                                                                                      
                                                                                                                                                           
    // ALL must match                                                                                                                                      
    if (filenameDate !== dataMatch[1]) {                                                                                                                   
      errors.push(`Filename date (${filenameDate}) ≠ XML Data (${dataMatch[1]})`);                                                                         
    }                                                                                                                                                      
                                                                                                                                                           
    if (filenameDate !== dataGenMatch[1]) {                                                                                                                
      errors.push(`Filename date (${filenameDate}) ≠ XML DataGenerazione (${dataGenMatch[1]})`);                                                           
    }                                                                                                                                                      
                                                                                                                                                           
    if (dataMatch[1] !== dataGenMatch[1]) {                                                                                                                
      errors.push(`XML Data (${dataMatch[1]}) ≠ XML DataGenerazione (${dataGenMatch[1]})`);                                                                
    }                                                                                                                                                      
                                                                                                                                                           
    return { valid: errors.length === 0, errors };                                                                                                         
  }                                                                                                                                                        
                                                                                                                                                           
  // Use before sending:                                                                                                                                   
  const validation = validateReportDates(filename, xml);                                                                                                   
  if (!validation.valid) {                                                                                                                                 
    throw new Error(`Date validation failed: ${validation.errors.join(', ')}`);                                                                            
  }                                                                                                                                                        
                                                                                                                                                           
  ---                                                                                                                                                      
  TESTING CHECKLIST                                                                                                                                        
                                                                                                                                                           
  Test 1: First Submission (New)                                                                                                                           
  - Generate RPG for 2026-01-30                                                                                                                            
  - Verify: Sostituzione="N", ProgressivoGenerazione="001"                                                                                                 
  - Check all dates match in filename and XML                                                                                                              
  - Database record created with status='sent'                                                                                                             
  - SIAE response accepted (code 0000)                                                                                                                     
                                                                                                                                                           
  Test 2: Second Submission (Replacement)                                                                                                                  
  - Send RPG for same date 2026-01-30 again                                                                                                                
  - Verify: Sostituzione="S", ProgressivoGenerazione="002"                                                                                                 
  - No error 0604 from SIAE                                                                                                                                
  - Database shows both records                                                                                                                            
                                                                                                                                                           
  Test 3: Date Validation                                                                                                                                  
  - Manually create XML with mismatched dates                                                                                                              
  - Verify validation catches the error before sending                                                                                                     
                                                                                                                                                           
  Test 4: Response Processing                                                                                                                              
  - Simulate SIAE response file                                                                                                                            
  - Verify database status updates correctly                                                                                                               
                                                                                                                                                           
  ---                                                                                                                                                      
  REPORT BACK                                                                                                                                              
                                                                                                                                                           
  After implementation, show me:                                                                                                                           
  1. Database schema confirmation: SELECT sql FROM sqlite_master WHERE name='siae_transmissions'                                                           
  2. Sample database record: SELECT * FROM siae_transmissions LIMIT 1                                                                                      
  3. Log output showing Sostituzione logic working                                                                                                         
  4. SIAE response for replacement (should be 0000, not 0604